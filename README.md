# Lambda funcitons with Localstack with docker-compose


## Deploying lambda function and running it with localstack

Reference: https://docs.localstack.cloud/user-guide/aws/lambda/


1. Create a docker-compose.yml file and run the container

```yml
version: "3.8"

services:
  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME:-localstack-main}"
    image: localstack/localstack
    ports:
      - "127.0.0.1:4566:4566"            # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559"  # external services port range
    environment:
      # LocalStack configuration: https://docs.localstack.cloud/references/configuration/
      - DEBUG=${DEBUG:-0}
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
```

and 

```sh
docker-compose up
```

2. Create a lambda function (must be "index.js file")

```js
exports.handler = async (event) => {
    const response = {
        statusCode: 200,
        body: "OK",
    };
    return response;
};  
```

3. Zip the function

```sh
zip function.zip ./index.js
```

4. Upload the lambda function code to localstack

awslocal is a cli for communicating with localstack. It can be either a aws-local cli or the alias which uses actual aws cli.
Instalation steps for awslocal cli [are here](#configuring-awslocal-cli).

```sh
awslocal lambda create-function \                                                  
    --function-name lambda-test \
    --runtime nodejs18.x \
    --zip-file fileb://function.zip \ 
    --handler index.handler \
    --role arn:aws:iam::000000000000:role/lambda-role
```

It might take time to activate the lambda function (to change it's state from "Pending" to "Active").

The function is ready to be invoked via cli:
```sh
awslocal lambda invoke --function-name lambda-test output.txt
```

5. To allow access through http to the lambda funciton we create a link to that function

```sh
awslocal lambda create-function-url-config \
    --function-name lambda-test \
    --auth-type NONE
```

From now on lambda function is available via http request under the url simmilar to this: `http://{autogenerated_id}.lambda-url.us-east-1.localhost.localstack.cloud:4566/`

## Configuring awslocal cli

There are several options to do the configuration but this one is the easies.

Other options: https://github.com/localstack/awscli-local

1. Install awscli for your system: https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html

2. Add an alias for the awscli which will play as the awslocal cli:

Add this line to your console config (in this case ~/.zshrc)

```sh
alias awslocal="AWS_ACCESS_KEY_ID=test AWS_SECRET_ACCESS_KEY=test AWS_DEFAULT_REGION=${DEFAULT_REGION:-$AWS_DEFAULT_REGION} aws --endpoint-url=http://${LOCALSTACK_HOST:-localhost}:4566"
```

3. Restart console (zsh --login) or open new terminal

4. Test if works:
```sh
awslocal --version
```
As a result you should see a similar output:
```sh
aws-cli/2.15.8 Python/3.11.6 Darwin/23.2.0 exe/x86_64 prompt/off
```